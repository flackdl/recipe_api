<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Recipe DB</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
	<link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
	<link rel="icon" type="image/png" href="/static/logo.png">
	<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
	<style>
		.recipe .tag {
			margin: 2px 0;
		}
		.recipe-image {
			object-fit: cover;
		}
		.text-right {
			text-align: right;
		}
	</style>
</head>

<body>

	<div id="app" class="container">
		<div>
			<template>
				<b-navbar>
					<template slot="brand">
						<b-navbar-item tag="router-link" to="/">
							<img src="/static/logo.png">&nbsp;&nbsp;Home
						</b-navbar-item>
					</template>
					<template slot="start">
						<b-navbar-item tag="router-link" to="/api">
							API
						</b-navbar-item>
					</template>
				</b-navbar>
			</template>
			<section class="section">
				<div class="container">
					<transition>
						<router-view></router-view>
					</transition>
				</div>
			</section>
		</div>
	</div>

	<!-- home -->
	<script type="text/x-template" id="main">
		<div>
			<section class="hero">
				<div class="hero-body">
					<div class="container">
						<h1 class="title">Recipe Database</h1>
						<h2 class="subtitle">A recipe <strong>database</strong> with <strong>api</strong> access</h2>
					</div>
				</div>
			</section>
			<div>
				<!-- search -->
				<form class="columns is-multiline" @submit="onSearch">
					<!-- search input -->
					<div class="column is-12">
						<b-field>
							<b-input placeholder="Search..." id="search" v-model="searchQuery" type="search" icon-pack="fas" size="is-large" icon="search">
							</b-input>
						</b-field>
					</div>
					<!-- cuisine filter -->
					<b-field class="column is-4">
						<b-taginput
							v-model="cuisinesChosen"
							:data="cuisinesFiltered"
							size="is-small"
							icon-pack="fas"
							icon="globe-americas"
							type="is-info"
							autocomplete
							:open-on-focus="true"
							field="name"
							placeholder="cuisines..."
							@add="cuisineAdded"
							@typing="getFilteredCuisines">
						</b-taginput>
					</b-field>
					<!-- category filter -->
					<b-field class="column is-4">
						<b-taginput
							v-model="categoriesChosen"
							:data="categoriesFiltered"
							size="is-small"
							icon-pack="fas"
							icon="utensils"
							type="is-info"
							autocomplete
							:open-on-focus="true"
							field="name"
							placeholder="categories..."
							@add="categoryAdded"
							@typing="getFilteredCategories">
						</b-taginput>
					</b-field>
					<div class="field column">
						<b-switch size="is-small" v-model="hasImage" @change.native="onSearch($event)">has image</b-switch>
					</div>
					<div class="column is-12 text-right">
						<button class="button is-primary is-light is-large">Search</button>
					</div>
				</form>
				<!-- search results loading -->
				<section v-if="isLoading">
					<b-skeleton width="20%" :animated="true"></b-skeleton>
					<b-skeleton width="40%" :animated="true"></b-skeleton>
					<b-skeleton width="80%" :animated="true"></b-skeleton>
					<b-skeleton :animated="true"></b-skeleton>
				</section>
				<!-- search results -->
				<div v-if="!isLoading">
					<div v-if="searchResults && searchResults.results.length === 0" class="notification is-warning">
						There were no results found
					</div>
					<div class="section columns is-multiline" v-if="hasSearchResults()">
						<div class="column is-12 has-text-grey-light is-size-6 text-right">
							<div>{{ searchResults.count }} results</div>
						</div>
						<div class="card column is-half-tablet is-one-third-desktop" v-for="recipe in searchResults.results" :key="recipe.slug">
							<router-link :to="{path: '/recipe/' + recipe.slug}" class="has-text-dark">
								<div class="card-image">
									<figure class="image is-4by3">
										<img class="recipe-image" :src="recipe.image_path || '/static/recipes/empty.png'">
									</figure>
								</div>
								<div class="card-content">
									<div class="media">
										<div class="media-content">
											<recipe-header :recipe="recipe"></recipe-header>
										</div>
									</div>
									<!-- description -->
									<div class="content" v-html="recipe.description"></div>
								</div>
							</router-link>
						</div>
						<div class="column is-12 text-right" v-if="searchResults.next">
							<button class="button is-info is-light is-large" @click="loadNextPage()">Next</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</script>


	<!-- recipe header -->
	<script type="text/x-template" id="recipe-header">
		<div class="recipe">
			<p class="title is-4">{{ recipe.name }}</p>
			<div class="subtitle is-6">
				<div><span class="tag is-light">Time</span> {{ recipe.total_time }} minutes</div>
				<div><span class="tag is-light">Servings</span> {{ recipe.servings }}</div>
				<div v-if="recipe.rating_value">
					<span class="tag is-light">Rating</span>
					<span v-for="rating in [1,2,3,4,5]">
					<i class="far fa-star is-small" :class="{'has-text-success': recipe.rating_value >= rating}"></i>
				</span>
					<small class="has-text-grey-light">({{ recipe.rating_count }})</small>
				</div>
			</div>
		</div>
	</script>

	<!-- recipe -->
	<script type="text/x-template" id="recipe">
		<div v-if="recipe" class="card">
			<div class="card-content">
				<div class="media">
					<div class="media-content">
						<recipe-header :recipe="recipe"></recipe-header>
					</div>
				</div>
				<div class="content">
					<div class="columns">
						<div class="column" v-html="recipe.description"></div>
						<div class="column">
							<figure class="image">
								<img :src="recipe.image_path">
							</figure>
						</div>
					</div>
					<div class="columns">
						<div class="column is-6">
								<h2>Ingredients</h2>
								<li v-for="ingredient in recipe.ingredients">{{ ingredient }}</li>
						</div>
						<div class="column is-6">
							<h2>Instructions</h2>
							<li v-for="instruction in recipe.instructions">{{ instruction }}</li>
						</div>
					</div>
				</div>
			</div>
		</div>
  </script>

	<!-- api -->
	<script type="text/x-template" id="api">
		<section class="hero">
			<div class="hero-body">
				<div class="container">
					<h1 class="title">
						Recipe API
					</h1>
					<h2 class="subtitle">
						The recipe database is powered by a public REST API.  The source code is open source.
					</h2>
					<div class="content">
						<ul>
							<li>
								<a href="/api/">api</a>
							</li>
							<li>
								<a href="https://github.com/flackdl/recipe_api">source code</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</section>
  </script>

<script src="https://unpkg.com/vue@2.6.11/dist/vue.js"></script>
<script src="https://unpkg.com/buefy@0.8.17/dist/buefy.min.js"></script>
<script src="https://unpkg.com/rxjs@6.5.5/bundles/rxjs.umd.min.js"></script>
<script src="https://unpkg.com/vue-router@3.1.6/dist/vue-router.js"></script>

<script>
	// recipe header component
	Vue.component('recipe-header', {
		props: ['recipe'],
		data: function () {
			return {
			}
		},
		template: '#recipe-header',
	});
	// main app
	let app = new Vue({
		el: '#app',
		router: new VueRouter({
			routes: [
				{ path: '/',
					name: 'main',
					component: {
						template: '#main',
						data () {
							return {
								page: 1,
								cuisines: [],
								categories: [],
								cuisinesFiltered: [],
								categoriesFiltered: [],
								cuisinesChosen: [],
								categoriesChosen: [],
								searchQuery: '',
								searchResults: null,
								isLoading: false,
								loadingComponent: null,
								hasImage: true,
								pageTitle: document.title,
							}
						},
						beforeRouteUpdate (to, from, next) {
							// react to route changes in the same component since the normal life cycle hooks aren't called
							this.searchQuery = to.query.search || '';
							this.page = to.query.page || 1;
							this.search();
							next();
						},
						created () {
							// initialize
							this.searchQuery = this.$route.query.search || '';
							this.page = parseInt(this.$route.query.page || 1);
							// reset page title
							document.title = this.pageTitle;

							// fetch core data
							this.loadCoreData().subscribe(() => {
								this.search();
							});
						},
						methods: {
							hasSearchResults() {
								return this.searchResults && this.searchResults.results.length > 0;
							},
							cuisineAdded() {
								// reset the cuisines choices
								this.cuisinesFiltered = this.cuisines.slice();
							},
							categoryAdded() {
								// reset the categories choices
								this.categoriesFiltered = this.categories.slice();
							},
							getFilteredCuisines(text) {
								this.cuisinesFiltered = this.cuisines.filter((cuisine) => {
									return cuisine.name
										.toLowerCase()
										.indexOf(text.toLowerCase()) >= 0
								})
							},
							getFilteredCategories(text) {
								this.categoriesFiltered = this.categories.filter((category) => {
									return category.name
										.toLowerCase()
										.indexOf(text.toLowerCase()) >= 0
								})
							},
							loadCoreData() {
								this.showLoading();
								return rxjs.forkJoin({
									'categories': rxjs.ajax.ajax.getJSON('/api/category/').pipe(
										rxjs.operators.map((data) => {
											this.categories = data.results;
											this.categoriesFiltered = this.categories.slice();
											return this.categories;
										}),
									),
									'cuisines': rxjs.ajax.ajax.getJSON('/api/cuisine/').pipe(
										rxjs.operators.map((data) => {
											this.cuisines = data.results;
											this.cuisinesFiltered = this.cuisines.slice();
											return this.cuisines;
										}),
									),
								}).pipe(
									rxjs.operators.tap(() => {
										this.hideLoading();
									})
								);
							},
							showLoading() {
								this.loadingComponent = this.$buefy.loading.open();
							},
							hideLoading () {
								this.loadingComponent.close();
							},
							onSearch (e) {
								// reset page since it's a new search
								this.page = 1;
								this.search();
								this.updateUrlParams();
								e.preventDefault();
							},
							search () {
								this.isLoading = true;

								// blur the input so the keyboard disappears on mobile devices
								document.querySelector('#search').blur();

								// fetch recipes
								this.fetchRecipes().then(() => {
									this.isLoading = false;
								});
							},
							loadNextPage() {
								this.page++;
								this.isLoading = true;
								this.updateUrlParams();
							},
							updateUrlParams() {
								// update the router query params
								this.$router.push({
									name: 'main',
									query: {
										search: this.searchQuery,
										page: this.page,
										// TODO - handle arrays in urls
										//cuisines: this.cuisinesChosen,
										//categories: this.categoriesChosen,
									},
								}).catch((e) => console.error(e));
							},
							fetchRecipes() {

								// add cuisines and categories filter
								let params = this.cuisinesChosen.map((cuisine) => {
									return `cuisines=${cuisine.id}`;
								}).concat(this.categoriesChosen.map((category) => {
									return `categories=${category.id}`;
								}));
								// add image filter
								if (this.hasImage) {
									params = params.concat([`has_image=${this.hasImage}`]);
								}
								// add page filter
								params = params.concat([`page=${this.page}`]);

								// construct url
								const url = `/api/recipe/?search=${this.searchQuery}&${params.join('&')}`;

								// fetch recipes
								return fetch(url).then((response) => {
									if (response.ok) {
										return response.json().then((data) => {
											this.searchResults = data;
										});
									} else {
										// TODO - show error
									}
								});
							},
						}
					}
				},
				{ path: '/recipe/:slug',
					name: 'recipe',
					component: {
						template: '#recipe',
						created () {
							fetch(`/api/recipe/?slug=${this.$route.params.slug}`).then((response) => {
								response.json().then((data) => {
									if (data.results.length > 0) {
										this.recipe = data.results[0];
										document.title = this.recipe.name;
									}
								})
							})
						},
						data () {
							return {
								recipe: null,
							}
						},
						methods: {
						}
					},
				},
				{ path: '/api', name: 'api', component: { template: '#api' }},
			],
		}),
	});
</script>
</body>
</html>
